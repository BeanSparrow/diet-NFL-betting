{% extends "base.html" %}

{% block title %}Analytics Dashboard - Diet NFL Betting{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">üìä Analytics Dashboard</h1>
            <p class="text-gray-600">Deep dive into betting patterns, trends, and community insights</p>
        </div>

        <!-- Analytics Selection System -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4">
                    <span class="text-sm font-medium text-gray-700">View:</span>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setView('global')" 
                               class="view-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-blue-600 text-white" 
                               data-view="global">
                            <i class="fas fa-globe mr-2"></i>Global
                        </button>
                        <button onclick="setView('accolades')" 
                               class="view-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" 
                               data-view="accolades">
                            <i class="fas fa-trophy mr-2"></i>Community Accolades
                        </button>
                        <button onclick="setView('weekly')" 
                               class="view-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" 
                               data-view="weekly">
                            <i class="fas fa-calendar-week mr-2"></i>Weekly
                        </button>
                    </div>
                </div>
                
                <!-- Week Selection (hidden by default) -->
                <div id="weekSelection" class="hidden flex flex-wrap items-center gap-4">
                    <span class="text-sm font-medium text-gray-700">Week:</span>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setWeek('current')" 
                               class="week-btn px-3 py-1 rounded-full text-sm transition duration-200 bg-blue-600 text-white" 
                               data-week="current">
                            Current
                        </button>
                        {% for week in range(1, 19) %}
                        <button onclick="setWeek({{ week }})" 
                               class="week-btn px-3 py-1 rounded-full text-sm transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" 
                               data-week="{{ week }}">
                            Week {{ week }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Global View Content -->
        <div id="globalView">
        <!-- Community Insights Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Active Users -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Users</p>
                        <p class="text-3xl font-bold text-blue-600">{{ community_insights.total_active_users or 0 }}</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Games Bet On -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Games with Bets</p>
                        <p class="text-3xl font-bold text-green-600">{{ community_insights.total_games_bet_on or 0 }}</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <i class="fas fa-football-ball text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Money in Play -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Money in Play</p>
                        <p class="text-3xl font-bold text-purple-600">${{ "%.0f"|format(community_insights.total_money_in_play or 0) }}</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Average Bet Size -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Avg Bet Size</p>
                        <p class="text-3xl font-bold text-orange-600">${{ "%.0f"|format(community_insights.average_bet_size_this_week or 0) }}</p>
                    </div>
                    <div class="bg-orange-100 rounded-full p-3">
                        <i class="fas fa-chart-bar text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Weekly Activity Charts -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Weekly Betting Activity</h3>
                
                <!-- Bet Count Chart -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Number of Bets</h4>
                    <div class="h-48">
                        <canvas id="weeklyBetsChart"></canvas>
                    </div>
                </div>
                
                <!-- Wagered Amount Chart -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Total Wagered</h4>
                    <div class="h-48">
                        <canvas id="weeklyWageredChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- User Balance Trend -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Your Balance Trend</h3>
                <div class="h-80">
                    <canvas id="balanceTrendChart"></canvas>
                </div>
            </div>
        </div>


        <!-- Community Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Most Popular Team -->
            {% if community_insights.most_popular_team %}
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h4 class="text-lg font-bold text-gray-900 mb-4">üèÜ Most Popular Team</h4>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ community_insights.most_popular_team.team }}</div>
                    <div class="text-sm text-gray-600">{{ community_insights.most_popular_team.bet_count }} bets</div>
                </div>
            </div>
            {% endif %}


            <!-- Biggest Upset -->
            {% if community_insights.biggest_upset %}
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h4 class="text-lg font-bold text-gray-900 mb-4">üò± Biggest Upset</h4>
                <div class="text-center">
                    <div class="text-sm font-bold text-red-600">{{ community_insights.biggest_upset.winner }}</div>
                    <div class="text-xs text-gray-600">Week {{ community_insights.biggest_upset.week }}</div>
                    <div class="text-xs text-gray-500">{{ community_insights.biggest_upset.winner_bets }}:{{ community_insights.biggest_upset.loser_bets }} bet ratio</div>
                </div>
            </div>
            {% endif %}
        </div>

        </div> <!-- End Global View -->

        <!-- Community Accolades View Content -->
        <div id="accoladesView" class="hidden">
        {% if community_insights.accolades %}
        <div class="bg-white rounded-xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-gray-900 mb-6">üèÖ Community Accolades</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                
                <!-- Money-Based Accolades -->
                {% if community_insights.accolades.high_roller %}
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üí∞</span>
                        <h5 class="font-bold text-gray-900">High Roller</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.high_roller.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.high_roller.value }} wagered</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.penny_pincher %}
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">ü™ô</span>
                        <h5 class="font-bold text-gray-900">Penny Pincher</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.penny_pincher.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.penny_pincher.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.all_in_andy %}
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üé∞</span>
                        <h5 class="font-bold text-gray-900">All-In Andy</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.all_in_andy.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.all_in_andy.value }} single bet</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.money_bags %}
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üíº</span>
                        <h5 class="font-bold text-gray-900">Money Bags</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.money_bags.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.money_bags.value }} balance</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.broke_as_joke %}
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üí∏</span>
                        <h5 class="font-bold text-gray-900">Broke as a Joke</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.broke_as_joke.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.broke_as_joke.value }} balance</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.minimalist %}
                <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg p-4 border border-teal-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">ü§è</span>
                        <h5 class="font-bold text-gray-900">Minimalist</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.minimalist.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.minimalist.value }} under $10</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.feast_or_famine %}
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üìà</span>
                        <h5 class="font-bold text-gray-900">Feast or Famine</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.feast_or_famine.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.feast_or_famine.value }}</div>
                </div>
                {% endif %}

                <!-- Performance Accolades -->
                {% if community_insights.accolades.rabbits_foot %}
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üçÄ</span>
                        <h5 class="font-bold text-gray-900">Rabbit's Foot</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.rabbits_foot.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.rabbits_foot.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.cursed %}
                <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-4 border border-slate-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üëª</span>
                        <h5 class="font-bold text-gray-900">Cursed</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.cursed.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.cursed.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.indecisive %}
                <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-4 border border-pink-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">ü§î</span>
                        <h5 class="font-bold text-gray-900">Indecisive</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.indecisive.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.indecisive.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.crystal_ball %}
                <div class="bg-gradient-to-br from-violet-50 to-violet-100 rounded-lg p-4 border border-violet-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üîÆ</span>
                        <h5 class="font-bold text-gray-900">Crystal Ball</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.crystal_ball.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.crystal_ball.value }} win rate</div>
                </div>
                {% endif %}

                <!-- Betting Pattern Accolades -->
                {% if community_insights.accolades.hometown_hero %}
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üè†</span>
                        <h5 class="font-bold text-gray-900">Hometown Hero</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.hometown_hero.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.hometown_hero.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.road_warrior %}
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border border-indigo-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üõ£Ô∏è</span>
                        <h5 class="font-bold text-gray-900">Road Warrior</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.road_warrior.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.road_warrior.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.one_trick_pony %}
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üê¥</span>
                        <h5 class="font-bold text-gray-900">One-Trick Pony</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.one_trick_pony.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.one_trick_pony.value }}</div>
                </div>
                {% endif %}

                {% if community_insights.accolades.early_bird %}
                <div class="bg-gradient-to-br from-sky-50 to-sky-100 rounded-lg p-4 border border-sky-200">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üê¶</span>
                        <h5 class="font-bold text-gray-900">Early Bird</h5>
                    </div>
                    <div class="text-sm font-medium text-blue-600">{{ community_insights.accolades.early_bird.username }}</div>
                    <div class="text-xs text-gray-600">{{ community_insights.accolades.early_bird.value }}</div>
                </div>
                {% endif %}

            </div>
        </div>
        {% endif %}
        </div> <!-- End Accolades View -->

        <!-- Weekly View Content -->
        <div id="weeklyView" class="hidden">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-900 mb-6" id="weeklyTitle">Weekly Game Analysis</h3>
                <div id="weeklyContent">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                        <p>Loading weekly data...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Analytics View Management (global scope)
let currentView = 'global';
let currentWeek = 'current';

function setView(view) {
    currentView = view;
    
    // Update view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        if (btn.dataset.view === view) {
            btn.className = 'view-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-blue-600 text-white';
        } else {
            btn.className = 'view-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
        }
    });
    
    // Hide all views first
    document.getElementById('globalView').style.display = 'none';
    document.getElementById('accoladesView').style.display = 'none';
    document.getElementById('weeklyView').style.display = 'none';
    document.getElementById('weekSelection').classList.add('hidden');
    
    // Show selected view
    if (view === 'global') {
        document.getElementById('globalView').style.display = 'block';
    } else if (view === 'accolades') {
        document.getElementById('accoladesView').style.display = 'block';
    } else if (view === 'weekly') {
        document.getElementById('weeklyView').style.display = 'block';
        document.getElementById('weekSelection').classList.remove('hidden');
        loadWeeklyData(currentWeek);
    }
}

function setWeek(week) {
    currentWeek = week;
    
    // Update week buttons
    document.querySelectorAll('.week-btn').forEach(btn => {
        if (btn.dataset.week == week) {
            btn.className = 'week-btn px-3 py-1 rounded-full text-sm transition duration-200 bg-blue-600 text-white';
        } else {
            btn.className = 'week-btn px-3 py-1 rounded-full text-sm transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
        }
    });
    
    loadWeeklyData(week);
}

function loadWeeklyData(week) {
    const weeklyContent = document.getElementById('weeklyContent');
    const weeklyTitle = document.getElementById('weeklyTitle');
    
    // Update title
    weeklyTitle.textContent = week === 'current' ? 'Current Week Game Analysis' : `Week ${week} Game Analysis`;
    
    // Show loading
    weeklyContent.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
            <p>Loading ${week === 'current' ? 'current week' : 'Week ' + week} data...</p>
        </div>
    `;
    
    // Fetch weekly data
    const url = week === 'current' 
        ? '/stats/api/weekly-games'
        : `/stats/api/weekly-games?week=${week}`;
        
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayWeeklyGames(data);
        })
        .catch(error => {
            console.error('Error loading weekly data:', error);
            weeklyContent.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                    <p>Error loading weekly data. Please try again.</p>
                </div>
            `;
        });
}

function displayWeeklyGames(games) {
    const weeklyContent = document.getElementById('weeklyContent');
    
    if (!games || games.length === 0) {
        weeklyContent.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-calendar-times text-2xl mb-4"></i>
                <p>No games found for this week.</p>
            </div>
        `;
        return;
    }

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
    
    games.forEach(game => {
        const awayBetPct = game.total_bets > 0 ? (game.away_bets / game.total_bets * 100) : 0;
        const homeBetPct = game.total_bets > 0 ? (game.home_bets / game.total_bets * 100) : 0;
        const awayMoneyPct = game.total_wagered > 0 ? (game.away_wagered / game.total_wagered * 100) : 0;
        const homeMoneyPct = game.total_wagered > 0 ? (game.home_wagered / game.total_wagered * 100) : 0;
        
        html += `
            <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="text-center mb-4">
                    <div class="font-bold text-lg text-gray-900">${game.away_team_abbr || game.away_team} @ ${game.home_team_abbr || game.home_team}</div>
                    <div class="text-sm text-gray-600">${new Date(game.game_time).toLocaleDateString()} ‚Ä¢ ${new Date(game.game_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    ${game.status === 'final' && game.winner ? `<div class="text-sm font-medium text-green-600 mt-1">Winner: ${game.winner}</div>` : ''}
                </div>
                
                ${game.total_bets > 0 ? `
                    <!-- Bet Distribution -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-medium text-gray-600">Bet Distribution</span>
                            <span class="text-xs text-gray-500">${game.total_bets} bets</span>
                        </div>
                        <div class="relative">
                            <div class="flex h-6 bg-gray-200 rounded overflow-hidden">
                                ${awayBetPct > 0 ? `<div class="bg-red-400 transition-all duration-500" style="width: ${awayBetPct}%"></div>` : ''}
                                ${homeBetPct > 0 ? `<div class="bg-blue-400 transition-all duration-500" style="width: ${homeBetPct}%"></div>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-red-600">${game.away_bets} (${awayBetPct.toFixed(0)}%)</span>
                            <span class="text-blue-600">${game.home_bets} (${homeBetPct.toFixed(0)}%)</span>
                        </div>
                    </div>
                    
                    <!-- Money Distribution -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-medium text-gray-600">Money Distribution</span>
                            <span class="text-xs text-gray-500">$${game.total_wagered.toFixed(0)}</span>
                        </div>
                        <div class="relative">
                            <div class="flex h-6 bg-gray-200 rounded overflow-hidden">
                                ${awayMoneyPct > 0 ? `<div class="bg-red-300 transition-all duration-500" style="width: ${awayMoneyPct}%"></div>` : ''}
                                ${homeMoneyPct > 0 ? `<div class="bg-blue-300 transition-all duration-500" style="width: ${homeMoneyPct}%"></div>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-red-600">$${(game.away_wagered || 0).toFixed(0)} (${awayMoneyPct.toFixed(0)}%)</span>
                            <span class="text-blue-600">$${(game.home_wagered || 0).toFixed(0)} (${homeMoneyPct.toFixed(0)}%)</span>
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-chart-bar text-lg mb-2"></i>
                        <div class="text-sm">No bets placed yet</div>
                    </div>
                `}
            </div>
        `;
    });
    
    html += '</div>';
    weeklyContent.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', function() {
    // Weekly Activity Charts
    const weeklyData = {{ week_stats | tojson }};
    
    // Weekly Bets Chart
    const weeklyBetsCtx = document.getElementById('weeklyBetsChart').getContext('2d');
    new Chart(weeklyBetsCtx, {
        type: 'bar',
        data: {
            labels: weeklyData.map(w => `Week ${w.week}`),
            datasets: [{
                label: 'Total Bets',
                data: weeklyData.map(w => w.total_bets),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: function(context) {
                            const max = context.chart.scales.y.max;
                            if (max <= 5) return 5;
                            if (max <= 10) return 5;
                            if (max <= 25) return 5;
                            if (max <= 50) return 10;
                            if (max <= 100) return 10;
                            if (max <= 250) return 25;
                            return Math.ceil(max / 10 / 5) * 5;
                        }
                    }
                },
                x: {}
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y} bet${context.parsed.y !== 1 ? 's' : ''}`;
                        }
                    }
                }
            }
        }
    });
    
    // Weekly Wagered Chart
    const weeklyWageredCtx = document.getElementById('weeklyWageredChart').getContext('2d');
    new Chart(weeklyWageredCtx, {
        type: 'line',
        data: {
            labels: weeklyData.map(w => `Week ${w.week}`),
            datasets: [{
                label: 'Total Wagered',
                data: weeklyData.map(w => w.total_wagered),
                borderColor: 'rgba(34, 197, 94, 1)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {}
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `$${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });

    // User Balance Trend Chart
    const balanceCtx = document.getElementById('balanceTrendChart').getContext('2d');
    const balanceData = {{ user_performance | tojson }};
    
    if (balanceData.length > 0) {
        new Chart(balanceCtx, {
            type: 'line',
            data: {
                labels: balanceData.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [{
                    label: 'Balance',
                    data: balanceData.map(d => d.balance),
                    borderColor: 'rgba(147, 51, 234, 1)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Your Balance Over Time'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    } else {
        balanceCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><p>No betting history yet - place some bets to see your trend!</p></div>';
    }

    // Mini charts for game distributions
    document.querySelectorAll('.mini-chart').forEach(canvas => {
        const awayBets = parseInt(canvas.dataset.awayBets);
        const homeBets = parseInt(canvas.dataset.homeBets);
        const awayTeam = canvas.dataset.awayTeam;
        const homeTeam = canvas.dataset.homeTeam;
        
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [awayTeam, homeTeam],
                datasets: [{
                    data: [awayBets, homeBets],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(59, 130, 246, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed}`;
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
    });
});
</script>
{% endblock %}